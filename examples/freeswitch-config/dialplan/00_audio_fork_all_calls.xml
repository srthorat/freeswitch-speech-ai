<include>
  <!--
    AUTOMATIC AUDIO FORKING FOR ALL CALLS

    This dialplan extension automatically forks audio for ALL calls
    to a WebSocket server for real-time processing.

    IMPORTANT:
    - The "00_" prefix ensures this runs BEFORE other dialplan extensions
    - continue="true" allows the call to proceed to other extensions
    - The condition field="destination_number" with expression="^.*$" matches ALL calls

    Installation:
    1. Copy this file to: /usr/local/freeswitch/conf/dialplan/default/00_audio_fork_all_calls.xml
    2. Reload: fs_cli -x 'reloadxml'
    3. Test by making any call
  -->
  <extension name="audio_fork_all_calls" continue="true">
    <!-- Match ALL calls - the condition MUST have a field attribute -->
    <condition field="destination_number" expression="^.*$">

      <!-- Log the call for debugging -->
      <action application="log" data="INFO [AUDIO_FORK] Starting audio fork: ${caller_id_number} â†’ ${destination_number}"/>

      <!-- Start audio forking to WebSocket server -->
      <action application="uuid_audio_fork" data="${uuid} start ws://20.244.30.42:8077/stream stereo 16k {'caller':'${caller_id_number}','callee':'${destination_number}','timestamp':'${strftime(%Y-%m-%d %H:%M:%S)}'}"/>

      <!-- Set hangup hook to stop audio forking when call ends -->
      <action application="set" data="api_hangup_hook=uuid_audio_fork ${uuid} stop {'end_time':'${strftime(%Y-%m-%d %H:%M:%S)}'}"/>

      <action application="log" data="INFO [AUDIO_FORK] Audio fork started successfully for ${uuid}"/>

    </condition>
  </extension>
</include>
